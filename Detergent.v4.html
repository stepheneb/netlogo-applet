<html>
<head>
<title>Detergent.v4</title>
<style type="text/css">
<!--
  :link { color: rgb(110, 0, 110); } 
  :visited { color: rgb(110, 0, 110); } 
  body { margin-left: 5px; font-family: arial, sans-serif; 
         background: white; font-size: 12pt } 
  h2 { background: rgb(166,172,255); 
       font-size: 15pt; 
       padding-left: 6px; padding-right: 6px; padding-top: 6px; 
       padding-bottom: 6px; } 
  p { margin-left: 10px; } 
  pre { margin-left: 13px; background: rgb(225,225,225); 
        font-family: monospace; padding-left: 3px; padding-right: 3px; 
        padding-top: 3px; padding-bottom: 3px; } 
-->
</style>
</head>
<body>

<p>This page was automatically generated by NetLogo 4.1.2.</p>

<p>The applet requires Java 5 or higher.
Java must be enabled in your browser settings.
Mac users must have Mac OS X 10.4 or higher.
Windows and Linux users may obtain the latest Java from
<a href="http://java.sun.com/getjava/download.html">Sun's Java site</a>.</p>

<p><hr>

<p><font size="-1">In order for this to work, this file, your model file
(Detergent.v4.nlogo), and the file NetLogoLite.jar
must all be in the same directory.  (You can copy NetLogoLite.jar
from the directory where you installed NetLogo.)</font></p>

<p><font size="-1">On some systems, you can test the applet locally on your computer
before uploading it to a web server.  It doesn't work on all systems,
though, so if it doesn't work from your hard drive, please try
uploading it to a web server.</font></p>

<p><font size="-1">You don't need to include everything in this file in your page.
If you want, you can just take the HTML code beginning with
&lt;applet&gt; and ending with &lt;/applet&gt;, and paste it into any HTML
file you want.  It's even OK to put multiple &lt;applet&gt; tags
on a single page.</font></p>

<p><font size="-1">If NetLogoLite.jar and your model are in different
directories, you must modify the archive= and value= lines
in the HTML code to point to their actual locations.
(For example, if you have multiple applets in different
directories on the same web server, you may want to put 
a single copy of NetLogoLite.jar in one central place and
change the archive= lines of all the HTML files to point
to that one central copy.  This will save disk space for
you and download time for your users.)</font></p>

<p>
<applet code="org.nlogo.lite.Applet"
        archive="NetLogoLite.jar"
        width="809" height="534">
  <param name="DefaultModel"
         value="Detergent.v4.nlogo">
</applet>
</p>

<p>powered by
<a target="_blank" href="http://ccl.northwestern.edu/netlogo/">NetLogo</a></p>

<p>view/download model file:
<a href="Detergent.v4.nlogo">Detergent.v4.nlogo</a>
</p>
<h2>WHAT IS IT?</h2>
<p>This is a model of detergents designed to have students think about the molecular properties of detergents and why they are effective at dispursing oil.</p><br>
<h2>HOW TO USE IT</h2>
<p>The model starts with a layer of yellow oil floating over blue water. If you shake it, the oil forms droplets in the water. These will recombine with the oil in a while unless you do somenting. </p>
<p>Three mystery molecules are available. Drop them in the solution by selecting the color of mystery molecule you want, and then clicking on the model. You can explore what the molecules do. </p>
<p>You can always see what the molecules look like, but that stops the model. Black stringy molecules are hydrocarbons that do not dissolve in water, red charged atoms are ions, that like the highly polarized environment of water.  </p><br>
<h2>THINGS TO TRY</h2>
<p>Try adding lots of molecules and see what their effect is on the oil. </p><br>
<h2>THINGS TO NOTICE</h2>
<p>Look at how one of the mystery molecules find the surfaces and line up. Why does this stabelize the oil droplets</p><br>
<h2>RELATED MODELS</h2>
<p>This section could give the names of models in the NetLogo Models Library or elsewhere which are of related interest.</p><br>
<h2>CREDITS AND REFERENCES</h2>
<p>Copyright 2011 (c) the Concord Consortium. You can use this for any purpose, providing you follow the LGPL license. <br>Designed and porgrammed by Robert Tinker for the VISUAL project. </p><br>
<h2>PROCEDURES</h2>
<pre><font color="#5a5a5a">; Detergent Model</font><font color="#000000">
</font><font color="#5a5a5a">; Bob Tinker</font><font color="#000000">
</font><font color="#5a5a5a">; copyright the Concord Consortium 2011 under the LGPL open source license</font><font color="#000000">
</font><font color="#5a5a5a">; March 2, 2011</font><font color="#000000">

</font><font color="#660096">breed</font><font color="#000000"> [drops drop]
</font><font color="#660096">breed</font><font color="#000000"> [ions ion]
</font><font color="#660096">breed</font><font color="#000000"> [oils oil]
</font><font color="#660096">breed</font><font color="#000000"> [soaps soap]
</font><font color="#660096">breed</font><font color="#000000"> [dots dot]
</font><font color="#660096">breed</font><font color="#000000"> [stoplights stoplight]

</font><font color="#007f69">drops-own</font><font color="#000000"> [vx vy ]
</font><font color="#007f69">dots-own</font><font color="#000000"> [vx vy fx fy owner]   </font><font color="#5a5a5a">; the owner is the who of a drop that owns a phospho-lipid, or (if zero) the oil-water surface. </font><font color="#000000">

</font><font color="#007f69">globals</font><font color="#000000"> [
  surface     </font><font color="#5a5a5a">; y-value of the oil-water surface</font><font color="#000000">
  drift       </font><font color="#5a5a5a">; the average drift velocity</font><font color="#000000">
  running?
  oil-area    </font><font color="#5a5a5a">; the total oil area in this model</font><font color="#000000">
  oil-top     </font><font color="#5a5a5a">; the top of the oil</font><font color="#000000">
  impulse     </font><font color="#5a5a5a">; a force per cycle applied to dots</font><font color="#000000">
  vmax        </font><font color="#5a5a5a">; the maximum allowed velocity component</font><font color="#000000">
  old-distance </font><font color="#5a5a5a">; used with moving magenta dots </font><font color="#000000">
  history      </font><font color="#5a5a5a">; this will be used to store the data needed to record a run. </font><font color="#000000">
  mode        </font><font color="#5a5a5a">; detemines the mode: running, re-running, setting, finding an event</font><font color="#000000">
  old-slider   </font><font color="#5a5a5a">; keeps the previous slider position</font><font color="#000000">
  current-state  </font><font color="#5a5a5a">; </font><font color="#000000">
  rerun-index  </font><font color="#5a5a5a">; </font><font color="#000000">
  combine-event?        </font><font color="#5a5a5a">; used to tag a frame in which oil drops combine</font><font color="#000000">
  merge-event?          </font><font color="#5a5a5a">; used to tag a frame in which an oil drop merge with the oil layer</font><font color="#000000">
]

</font><font color="#007f69">to</font><font color="#000000"> startup 
  </font><font color="#0000aa">ca</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> mode </font><font color="#963700">0</font><font color="#000000">   </font><font color="#5a5a5a">; start (and restart) in mode 0, which runs the simulation</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> old-slider tape-position   </font><font color="#5a5a5a">; read the slider and save its position</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> history [ ] 
  </font><font color="#0000aa">set</font><font color="#000000"> running? </font><font color="#963700">true</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> oil-area </font><font color="#963700">1800</font><font color="#000000">  </font><font color="#5a5a5a">; the constant oil area</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> oil-top </font><font color="#660096">max-pycor</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> </font><font color="#963700">3</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> surface (</font><font color="#660096">max-pycor</font><font color="#000000"> </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000">) </font><font color="#660096">-</font><font color="#000000"> oil-top      </font><font color="#5a5a5a">; this is where the horizontal surface appears</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> drift </font><font color="#963700">.05</font><font color="#000000">                 </font><font color="#5a5a5a">; the drift speed of oil and ions toward their preferred location</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> impulse </font><font color="#963700">.05</font><font color="#000000">             </font><font color="#5a5a5a">; controls the acceleration of drops </font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> vmax </font><font color="#963700">.1</font><font color="#000000">
  draw-patches oil-area         </font><font color="#5a5a5a">; draw the background showing air, oil, and water</font><font color="#000000">
  create-drops </font><font color="#963700">1</font><font color="#000000"> [</font><font color="#0000aa">die</font><font color="#000000">]          </font><font color="#5a5a5a">; flush out turtle 0 (a hack--  </font><font color="#000000">
  create-stoplights </font><font color="#963700">1</font><font color="#000000"> [         </font><font color="#5a5a5a">; this tells whether the model is running or not</font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;circle&quot;</font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">red</font><font color="#000000">
    </font><font color="#0000aa">setxy</font><font color="#000000"> </font><font color="#660096">max-pxcor</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> </font><font color="#660096">min-pycor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> ]  </font><font color="#5a5a5a">; place it in the upper left corner</font><font color="#000000">
</font><font color="#007f69">end</font><font color="#000000">  </font><font color="#5a5a5a">; I forgot that turtles start with zero and I need 0 to identify dots attached to the surface. )</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> draw-patches [oil-in-layer]      </font><font color="#5a5a5a">; draw patches that show this amount of oil in the top layer</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> oil-height </font><font color="#660096">round</font><font color="#000000"> (oil-in-layer </font><font color="#660096">/</font><font color="#000000"> (</font><font color="#963700">2</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">max-pxcor</font><font color="#000000">)) </font><font color="#5a5a5a">;  This is the vertical hieght of the oil layer</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> surface oil-top </font><font color="#660096">-</font><font color="#000000"> oil-height
  </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">patches</font><font color="#000000"> [
    </font><font color="#0000aa">ifelse</font><font color="#000000"> </font><font color="#660096">pycor</font><font color="#000000"> </font><font color="#660096">&gt;=</font><font color="#000000"> oil-top [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">white</font><font color="#000000"> ]
     [</font><font color="#0000aa">ifelse</font><font color="#000000"> </font><font color="#660096">pycor</font><font color="#000000"> </font><font color="#660096">&gt;=</font><font color="#000000"> surface 
        [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">48</font><font color="#000000">]           </font><font color="#5a5a5a">; light yellow</font><font color="#000000">
        [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">blue</font><font color="#000000">]]]
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> go            </font><font color="#5a5a5a">; this is the main loop--it switches, depending on mode</font><font color="#000000">
                 </font><font color="#5a5a5a">; 0 = run model. 1 = pause. 2 = re-run  3 = find next event 4 = find previous event 5 = use slider</font><font color="#000000">
  </font><font color="#0000aa">if</font><font color="#000000"> old-slider </font><font color="#660096">!=</font><font color="#000000"> tape-position [   </font><font color="#5a5a5a">; the modes are set by the corresponding buttons except for the slider</font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> old-slider tape-position
    </font><font color="#0000aa">set</font><font color="#000000"> mode </font><font color="#963700">5</font><font color="#000000">]
  </font><font color="#0000aa">if</font><font color="#000000"> mode </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [run-model] 
  </font><font color="#0000aa">if</font><font color="#000000"> mode </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> [re-run]
  </font><font color="#0000aa">if</font><font color="#000000"> mode </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">5</font><font color="#000000"> [use-slider]
  </font><font color="#0000aa">ifelse</font><font color="#000000"> mode </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> running?           </font><font color="#5a5a5a">; set stoplight green if the model is running. </font><font color="#000000">
    [</font><font color="#0000aa">ask</font><font color="#000000"> stoplights [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">green</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">label</font><font color="#000000"> </font><font color="#963700">&quot;Computing    &quot;</font><font color="#000000">]]
    [</font><font color="#0000aa">ask</font><font color="#000000"> stoplights [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">red</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">label</font><font color="#000000"> </font><font color="#963700">&quot;Paused    &quot;</font><font color="#000000">]]
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> run-model  
  </font><font color="#0000aa">every</font><font color="#000000"> </font><font color="#963700">.01</font><font color="#000000">  [         </font><font color="#5a5a5a">; run this every .01 sec. </font><font color="#000000">
    </font><font color="#0000aa">if</font><font color="#000000"> running?  [ 
      </font><font color="#0000aa">set</font><font color="#000000"> tape-position </font><font color="#963700">100</font><font color="#000000">
      find-owners      </font><font color="#5a5a5a">; teach each soap molecule its owner, the drop to which it is attached, if any </font><font color="#000000">
      drop-dots 
      move-drops
      move-dots]]
  </font><font color="#0000aa">every</font><font color="#000000"> </font><font color="#963700">.02</font><font color="#000000"> [</font><font color="#0000aa">if</font><font color="#000000"> running? [save-state]]  </font><font color="#5a5a5a">; record the state of the system</font><font color="#000000">
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> drop-dots
  </font><font color="#0000aa">let</font><font color="#000000"> cnum </font><font color="#660096">read-from-string</font><font color="#000000"> mystery-molecule 
  </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">mouse-down?</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> </font><font color="#660096">mouse-inside?</font><font color="#000000"> [
      create-dots </font><font color="#963700">1</font><font color="#000000"> [                     </font><font color="#5a5a5a">; create a mystery particle at the mouse location</font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> vx vmax </font><font color="#660096">*</font><font color="#000000"> random-between </font><font color="#963700">-1</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> vy vmax </font><font color="#660096">*</font><font color="#000000"> random-between </font><font color="#963700">-1</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;circle&quot;</font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000">  
        </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> cnum
        </font><font color="#0000aa">let</font><font color="#000000"> x </font><font color="#660096">mouse-xcor</font><font color="#000000">
        </font><font color="#0000aa">let</font><font color="#000000"> y </font><font color="#660096">mouse-ycor</font><font color="#000000">
        </font><font color="#0000aa">setxy</font><font color="#000000"> x y
        </font><font color="#0000aa">set</font><font color="#000000"> owner </font><font color="#963700">-1</font><font color="#000000">
</font><font color="#5a5a5a">;        set label owner</font><font color="#000000">
      ]
    </font><font color="#0000aa">wait</font><font color="#000000"> </font><font color="#963700">.1</font><font color="#000000">]
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> move-dots
  </font><font color="#0000aa">ask</font><font color="#000000"> dots [
    </font><font color="#0000aa">set</font><font color="#000000"> fx </font><font color="#963700">0</font><font color="#000000">                        </font><font color="#5a5a5a">; the dots are subject to various forces </font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> fy </font><font color="#963700">0</font><font color="#000000"> ]                      </font><font color="#5a5a5a">; the forces are recomputed each cycle</font><font color="#000000">
  
  </font><font color="#0000aa">ask</font><font color="#000000"> dots [                        </font><font color="#5a5a5a">; some rules that apply to all dots   </font><font color="#000000">
    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&gt;</font><font color="#000000"> oil-top </font><font color="#660096">-</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> [         </font><font color="#5a5a5a">; if any dots are too near the top of the oil, aim them down. </font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> </font><font color="#660096">abs</font><font color="#000000"> vy ]           </font><font color="#5a5a5a">; set vy negative, even if this is called multiple times</font><font color="#000000">
    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#660096">min-pycor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> [       </font><font color="#5a5a5a">; if any dots are too near the bottom, send them up. </font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#660096">abs</font><font color="#000000"> vy ] 

    </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">in-radius</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000">            </font><font color="#5a5a5a">; push away other dots</font><font color="#000000">
      [ </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">not</font><font color="#000000"> (</font><font color="#660096">who</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> [</font><font color="#660096">who</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">) [    </font><font color="#5a5a5a">;ignore me</font><font color="#000000">
          </font><font color="#0000aa">face</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">               </font><font color="#5a5a5a">; ask the second dot to face the first</font><font color="#000000">
          </font><font color="#0000aa">set</font><font color="#000000"> fx fx </font><font color="#660096">-</font><font color="#000000"> impulse </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">sin</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000">  </font><font color="#5a5a5a">; give it an impluse away</font><font color="#000000">
          </font><font color="#0000aa">set</font><font color="#000000"> fy fy </font><font color="#660096">-</font><font color="#000000"> impulse </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">cos</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000">
        ]]]
  
  </font><font color="#0000aa">ask</font><font color="#000000"> drops [                     </font><font color="#5a5a5a">; handle dot motion in and out of drops</font><font color="#000000">
    </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">in-radius</font><font color="#000000"> ( </font><font color="#963700">.55</font><font color="#000000">  </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> ) [   </font><font color="#5a5a5a">; talk to dots near each drop</font><font color="#000000">
      </font><font color="#0000aa">ifelse</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">magenta</font><font color="#000000">  [         </font><font color="#5a5a5a">; come on in</font><font color="#000000">
        </font><font color="#0000aa">let</font><font color="#000000"> new-distance </font><font color="#660096">distance</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">
        </font><font color="#0000aa">if</font><font color="#000000"> new-distance </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">.4</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> [</font><font color="#660096">size</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> new-distance </font><font color="#660096">&gt;</font><font color="#000000"> old-distance 
           [  </font><font color="#5a5a5a">; aim toward center of drop if already inside and moving outward</font><font color="#000000">
           </font><font color="#0000aa">face</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> 
           </font><font color="#0000aa">set</font><font color="#000000"> fx fx </font><font color="#660096">+</font><font color="#000000"> impulse </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">sin</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000">  </font><font color="#5a5a5a">; give it an impluse </font><font color="#000000">
           </font><font color="#0000aa">set</font><font color="#000000"> fy fy </font><font color="#660096">+</font><font color="#000000"> impulse </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">cos</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> ]
         </font><font color="#0000aa">set</font><font color="#000000"> old-distance new-distance ]
       [</font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">green</font><font color="#000000">  [          </font><font color="#5a5a5a">; go away from drop</font><font color="#000000">
            </font><font color="#0000aa">face</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> 
            </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">180</font><font color="#000000">]
          </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">black</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> surface [            </font><font color="#5a5a5a">; trap them in the boundary</font><font color="#000000">
            </font><font color="#0000aa">face</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">
            </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">distance</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">.5</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> [</font><font color="#660096">size</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> [
              </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">180</font><font color="#000000"> ]]
      
        </font><font color="#0000aa">set</font><font color="#000000"> fx fx </font><font color="#660096">+</font><font color="#000000"> impulse </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">sin</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000">  </font><font color="#5a5a5a">; give it an impluse </font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> fy fy </font><font color="#660096">+</font><font color="#000000"> impulse </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">cos</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> ]]]   
       
  </font><font color="#5a5a5a">; move the free magenta dots</font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">magenta</font><font color="#000000">][
</font><font color="#5a5a5a">;    if (ycor &lt; surface + 2)  [         ; if below the surface, move upward, toward the horizontal oil surface</font><font color="#000000">
</font><font color="#5a5a5a">;      set ycor ycor + drift ]</font><font color="#000000">
    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&gt;</font><font color="#000000"> surface </font><font color="#660096">and</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> surface </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> vy </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [ </font><font color="#5a5a5a">; if coming down from above</font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> vy ]               </font><font color="#5a5a5a">; turn it around</font><font color="#000000">
     ]
  
  </font><font color="#5a5a5a">; move the green dots into the water</font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">green</font><font color="#000000">][
</font><font color="#5a5a5a">;    if ycor &gt; surface - 2 </font><font color="#000000">
</font><font color="#5a5a5a">;      [set ycor ycor - drift ]</font><font color="#000000">
     </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> surface </font><font color="#660096">and</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&gt;</font><font color="#000000"> surface </font><font color="#660096">-</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> vy </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [ </font><font color="#5a5a5a">; if coming up from below</font><font color="#000000">
       </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> vy ]               </font><font color="#5a5a5a">; turn it around</font><font color="#000000">
     ]
   
  </font><font color="#5a5a5a">; move the black dots to the horizontal interface</font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">black</font><font color="#000000"> ][
     </font><font color="#0000aa">ifelse</font><font color="#000000"> owner </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [    </font><font color="#5a5a5a">; if owned by the horizontal surface</font><font color="#000000">
       </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000"> ]     </font><font color="#5a5a5a">; trap the dot at the surface</font><font color="#000000">
       [ </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#660096">max-pycor</font><font color="#000000"> </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> fy </font><font color="#963700">.002</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> drift ]]]   </font><font color="#5a5a5a">; these float upward, helping ensure a soaped horizontal layer</font><font color="#000000">

  </font><font color="#5a5a5a">; finally, move the dots. </font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [owner </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> ][    </font><font color="#5a5a5a">; these are the free-floating dots</font><font color="#000000">
    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">random</font><font color="#000000"> </font><font color="#963700">1000</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [         </font><font color="#5a5a5a">; every once in a while, hit with a random force direction</font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> fx fx </font><font color="#660096">+</font><font color="#000000"> impulse </font><font color="#660096">*</font><font color="#000000"> random-between </font><font color="#963700">-1</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> 
      </font><font color="#0000aa">set</font><font color="#000000"> fy fy </font><font color="#660096">+</font><font color="#000000"> impulse </font><font color="#660096">*</font><font color="#000000"> random-between </font><font color="#963700">-1</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">      
      ]
   advance-dots
    ] 
  
  </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [owner </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> ][                 </font><font color="#5a5a5a">; ask dots on the horizontal surface</font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> fy </font><font color="#963700">0</font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> vx vx </font><font color="#660096">+</font><font color="#000000"> fx  
    advance-dots]  </font><font color="#5a5a5a">; rattle back and forth </font><font color="#000000">
  
  </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [owner </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> ] [                  </font><font color="#5a5a5a">; ask dots owned by a drop</font><font color="#000000">
    </font><font color="#0000aa">ask</font><font color="#000000"> drops </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">who</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> [owner] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">] [
        </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> [
           </font><font color="#0000aa">set</font><font color="#000000"> vx [vx] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">                </font><font color="#5a5a5a">; the dot adopts the velocity of the owner</font><font color="#000000">
           </font><font color="#0000aa">set</font><font color="#000000"> vy [vy] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> ]]             
   advance-dots ]
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> advance-dots  </font><font color="#5a5a5a">; in dot context, moves dot along</font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> vx vx </font><font color="#660096">+</font><font color="#000000"> fx  
    </font><font color="#0000aa">set</font><font color="#000000"> vy vy </font><font color="#660096">+</font><font color="#000000"> fy 
    </font><font color="#0000aa">if</font><font color="#000000"> vx </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> vmax [</font><font color="#0000aa">set</font><font color="#000000"> vx </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> vmax]
    </font><font color="#0000aa">if</font><font color="#000000"> vx </font><font color="#660096">&gt;</font><font color="#000000"> vmax [</font><font color="#0000aa">set</font><font color="#000000"> vx vmax]
    </font><font color="#0000aa">if</font><font color="#000000"> vy </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> vmax [</font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> vmax]
    </font><font color="#0000aa">if</font><font color="#000000"> vy </font><font color="#660096">&gt;</font><font color="#000000"> vmax [</font><font color="#0000aa">set</font><font color="#000000"> vy vmax]
    </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> vx  </font><font color="#5a5a5a">; move them</font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> vy 
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> shake  </font><font color="#5a5a5a">; causes drops to be created in the oil layer</font><font color="#000000">
  </font><font color="#0000aa">if</font><font color="#000000"> surface </font><font color="#660096">&lt;</font><font color="#000000"> oil-top [
    create-drops </font><font color="#963700">1</font><font color="#000000"> [                      </font><font color="#5a5a5a">; create a drop</font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;circle&quot;</font><font color="#000000">
</font><font color="#5a5a5a">;      set label who</font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> vx drift </font><font color="#660096">*</font><font color="#000000"> random-between </font><font color="#963700">-2</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> </font><font color="#5a5a5a">;  left or right</font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000">  drift </font><font color="#5a5a5a">;  drift downward</font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">48</font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> random-between </font><font color="#963700">4</font><font color="#000000"> </font><font color="#963700">10</font><font color="#000000">
      </font><font color="#0000aa">let</font><font color="#000000"> rad </font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000"> random-between </font><font color="#963700">0</font><font color="#000000"> (</font><font color="#963700">2</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">max-pxcor</font><font color="#000000">)
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> surface </font><font color="#660096">+</font><font color="#000000"> rad
    ] ] 
</font><font color="#007f69">end</font><font color="#000000">
  
</font><font color="#007f69">to</font><font color="#000000"> find-owners  </font><font color="#5a5a5a">; looks at every black dot and assigns it an owner</font><font color="#000000">
  </font><font color="#5a5a5a">; this is used in the calculation of the soap-soap repulsion </font><font color="#000000">
  </font><font color="#5a5a5a">; an owner of -1 means unowned</font><font color="#000000">
  </font><font color="#5a5a5a">; an owner of 0 means the dot is at the water-oil surface</font><font color="#000000">
  </font><font color="#5a5a5a">; an owner of w means that the dot is owned by a drop with a who? of w (w&gt;0)</font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">black</font><font color="#000000">] [     
    </font><font color="#0000aa">set</font><font color="#000000"> owner </font><font color="#963700">-1</font><font color="#000000">
    </font><font color="#0000aa">ifelse</font><font color="#000000"> </font><font color="#660096">abs</font><font color="#000000"> (</font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> surface) </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">.4</font><font color="#000000">   </font><font color="#5a5a5a">; if it is near the horizontal surface</font><font color="#000000">
       [</font><font color="#0000aa">set</font><font color="#000000"> owner </font><font color="#963700">0</font><font color="#000000"> ]
       [               </font><font color="#5a5a5a">; if not near the horizontal surface, is it on the surface of any drop?</font><font color="#000000">
          </font><font color="#0000aa">ask</font><font color="#000000"> drops [                    </font><font color="#5a5a5a">; check every drop</font><font color="#000000">
            </font><font color="#0000aa">let</font><font color="#000000"> drop-who </font><font color="#660096">who</font><font color="#000000">             </font><font color="#5a5a5a">; save the who of this drop</font><font color="#000000">
            </font><font color="#0000aa">let</font><font color="#000000"> d </font><font color="#660096">distancexy</font><font color="#000000"> ([</font><font color="#660096">xcor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">) ([</font><font color="#660096">ycor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">)  </font><font color="#5a5a5a">; d is the distance between dot and drop</font><font color="#000000">
            </font><font color="#0000aa">if</font><font color="#000000"> ((</font><font color="#660096">abs</font><font color="#000000"> (d </font><font color="#660096">-</font><font color="#000000"> </font><font color="#963700">.5</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> ) </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">) </font><font color="#660096">and</font><font color="#000000"> ([</font><font color="#660096">ycor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> surface )) [  </font><font color="#5a5a5a">; for black dots on the surface of a drop and below the surface</font><font color="#000000">
              </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> [</font><font color="#0000aa">set</font><font color="#000000"> owner drop-who ]]]]   </font><font color="#5a5a5a">; set the owner of the dot to the who of the drop  </font><font color="#000000">
  ]
</font><font color="#007f69">end</font><font color="#000000">                       

</font><font color="#007f69">to</font><font color="#000000"> move-drops </font><font color="#5a5a5a">; handles the motion of drops</font><font color="#000000">
 
  </font><font color="#5a5a5a">; first adjust the surface level based on where the drops are</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> area </font><font color="#963700">0</font><font color="#000000">    </font><font color="#5a5a5a">; add up the area of drops below the surface</font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> drops [
    </font><font color="#0000aa">let</font><font color="#000000"> drop-area  </font><font color="#963700">pi</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> (</font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">^</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000">) </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000">   </font><font color="#5a5a5a">; the area of a droplet</font><font color="#000000">
    </font><font color="#0000aa">ifelse</font><font color="#000000"> (</font><font color="#660096">ycor</font><font color="#000000">  </font><font color="#660096">&gt;</font><font color="#000000"> surface </font><font color="#660096">+</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> )  [ ] </font><font color="#5a5a5a">; if the drop is entirely in the oil, do nothing</font><font color="#000000">
      [</font><font color="#0000aa">ifelse</font><font color="#000000"> (</font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> surface ) [</font><font color="#0000aa">set</font><font color="#000000"> area area </font><font color="#660096">+</font><font color="#000000"> drop-area ]  </font><font color="#5a5a5a">; if it entirely in the water, add the drop area. </font><font color="#000000">
        </font><font color="#5a5a5a">; you get here if the droplet is partly in the water, partly in the oil</font><font color="#000000">
        [</font><font color="#0000aa">let</font><font color="#000000"> f (surface </font><font color="#660096">-</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> (</font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> )) </font><font color="#660096">/</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000">    </font><font color="#5a5a5a">; calculate the fraction of the drop in the water </font><font color="#000000">
           </font><font color="#0000aa">set</font><font color="#000000"> area area </font><font color="#660096">+</font><font color="#000000"> drop-area </font><font color="#660096">*</font><font color="#000000"> f ]]]
     </font><font color="#5a5a5a">; area now contains the total area of drops. </font><font color="#000000">
     </font><font color="#0000aa">if</font><font color="#000000"> area </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [</font><font color="#0000aa">set</font><font color="#000000"> area </font><font color="#963700">0</font><font color="#000000"> ]
   draw-patches (oil-area </font><font color="#660096">-</font><font color="#000000"> area)  </font><font color="#5a5a5a">; redraw that background showing a new oil layer</font><font color="#000000">
   
  </font><font color="#5a5a5a">; now look for overlapping drops and combine them, preserving area. </font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> drops [
    </font><font color="#0000aa">ask</font><font color="#000000"> drops </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">who</font><font color="#000000"> </font><font color="#660096">&gt;</font><font color="#000000"> [</font><font color="#660096">who</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">] [          </font><font color="#5a5a5a">; look around for other drops </font><font color="#000000">
     </font><font color="#0000aa">let</font><font color="#000000"> d </font><font color="#660096">distancexy</font><font color="#000000"> ([</font><font color="#660096">xcor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> ) ([</font><font color="#660096">ycor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> )  </font><font color="#5a5a5a">; the distance to the other drop</font><font color="#000000">
     </font><font color="#0000aa">if</font><font color="#000000"> d </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">.4</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> (</font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> ([</font><font color="#660096">size</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">)) [ </font><font color="#5a5a5a">; if they overlap by a bit</font><font color="#000000">
        </font><font color="#0000aa">let</font><font color="#000000"> new-size </font><font color="#660096">sqrt</font><font color="#000000"> (</font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">^</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> ([</font><font color="#660096">size</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> ) </font><font color="#660096">^</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> ) </font><font color="#5a5a5a">; the size of the combined droplet</font><font color="#000000">
        </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> new-size]  </font><font color="#5a5a5a">; make me bigger</font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> combine-event? </font><font color="#963700">true</font><font color="#000000">           </font><font color="#5a5a5a">; this logical is used to tag this frame</font><font color="#000000">
        </font><font color="#0000aa">die</font><font color="#000000">
        ]]]     </font><font color="#5a5a5a">; kill off the other drop</font><font color="#000000">
  
  </font><font color="#0000aa">ask</font><font color="#000000"> drops [  </font><font color="#5a5a5a">; kill off drops that are in the oil going upward</font><font color="#000000">
    </font><font color="#0000aa">if</font><font color="#000000"> ((</font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&gt;=</font><font color="#000000"> surface </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">.5</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000">)  </font><font color="#660096">and</font><font color="#000000"> (vy </font><font color="#660096">&gt;=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> )) [
      </font><font color="#0000aa">set</font><font color="#000000"> merge-event? </font><font color="#963700">true</font><font color="#000000">              </font><font color="#5a5a5a">; this logical is used to tag this frame</font><font color="#000000">
      </font><font color="#0000aa">die</font><font color="#000000">
      ]]   </font><font color="#5a5a5a">; used to also allow &quot;or (ycor &gt; oil-top - 5))&quot;</font><font color="#000000">
  
  </font><font color="#0000aa">ask</font><font color="#000000"> dots [   </font><font color="#5a5a5a">; kick drops apart that have soap molecules between them  *** this stabelizes droplets coated with oil ***</font><font color="#000000">
    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">any?</font><font color="#000000"> dots </font><font color="#660096">in-radius</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> </font><font color="#660096">with</font><font color="#000000"> [owner </font><font color="#660096">!=</font><font color="#000000"> ([owner] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">) </font><font color="#660096">and</font><font color="#000000"> owner </font><font color="#660096">&gt;=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> ] [   </font><font color="#5a5a5a">; if there are any  nearby dots that have some other owner</font><font color="#000000">
      </font><font color="#0000aa">ask</font><font color="#000000"> drops </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">who</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000">  [owner] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> ][         </font><font color="#5a5a5a">;  ask my owner to move away </font><font color="#000000">
        </font><font color="#0000aa">face</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">                                       </font><font color="#5a5a5a">; face me and move away</font><font color="#000000">
        </font><font color="#0000aa">let</font><font color="#000000"> kick </font><font color="#963700">.3</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> drift                               </font><font color="#5a5a5a">; change in velocity per collision</font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> vx vx </font><font color="#660096">-</font><font color="#000000"> kick </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">sin</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000">                    </font><font color="#5a5a5a">; apply a force to part the dot and drop</font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> vy vy </font><font color="#660096">-</font><font color="#000000"> kick </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">cos</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> 
        </font><font color="#0000aa">if</font><font color="#000000"> vx </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> vmax [</font><font color="#0000aa">set</font><font color="#000000"> vx </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> vmax ]               </font><font color="#5a5a5a">; limit the velocity vectors </font><font color="#000000">
        </font><font color="#0000aa">if</font><font color="#000000"> vx </font><font color="#660096">&gt;</font><font color="#000000"> vmax [</font><font color="#0000aa">set</font><font color="#000000"> vx vmax]
        </font><font color="#0000aa">if</font><font color="#000000"> vy </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> vmax [</font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> vmax ]
        </font><font color="#0000aa">if</font><font color="#000000"> vy </font><font color="#660096">&gt;</font><font color="#000000"> vmax [</font><font color="#0000aa">set</font><font color="#000000"> vy vmax]
        ]]]                               </font><font color="#5a5a5a">; </font><font color="#000000">
  
    
  </font><font color="#5a5a5a">; add some randomness to the motion and then move the drop</font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> drops [
    </font><font color="#0000aa">if</font><font color="#000000"> (</font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&gt;</font><font color="#000000"> oil-top) [</font><font color="#0000aa">die</font><font color="#000000">]  </font><font color="#5a5a5a">; kill off any drops that get above the oil top</font><font color="#000000">
    </font><font color="#0000aa">if</font><font color="#000000"> (</font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> surface </font><font color="#660096">-</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000">) </font><font color="#660096">and</font><font color="#000000">  </font><font color="#5a5a5a">; if the drop is below the surface </font><font color="#000000">
      (( </font><font color="#660096">random</font><font color="#000000"> </font><font color="#963700">1000</font><font color="#000000"> ) </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> )[       </font><font color="#5a5a5a">; change direction once in a while</font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> vx drift </font><font color="#660096">*</font><font color="#000000"> random-between </font><font color="#963700">-2</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> vy drift </font><font color="#660096">*</font><font color="#000000"> (random-between </font><font color="#963700">-2</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> )]
        </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">20</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> vy vy </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">.002</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> drift ] </font><font color="#5a5a5a">; slowly drift upward if it is big</font><font color="#000000">
    </font><font color="#5a5a5a">; finally, move the drop    </font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> vx 
    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#660096">min-pycor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> [
      </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#660096">abs</font><font color="#000000"> vy ]             </font><font color="#5a5a5a">; bounce off the bottom  </font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> vy ]
</font><font color="#007f69">end</font><font color="#000000">
  
</font><font color="#007f69">to</font><font color="#000000"> show-molecules   </font><font color="#5a5a5a">; converts each dot into a molecule</font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> dots [
    </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#963700">8</font><font color="#000000">
    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">magenta</font><font color="#000000"> [
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;oil&quot;</font><font color="#000000">]
    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">green</font><font color="#000000"> [
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;ion&quot;</font><font color="#000000">]
    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">black</font><font color="#000000"> [
      </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">abs</font><font color="#000000"> (</font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> surface) </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">3</font><font color="#000000">  </font><font color="#5a5a5a">; if near the horizontal surface</font><font color="#000000">
        [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">heading</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">
          </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;soap2&quot;</font><font color="#000000">
          </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#963700">10</font><font color="#000000">
          ]  
    ]]
  
   </font><font color="#0000aa">ask</font><font color="#000000"> drops [          </font><font color="#5a5a5a">;look for black dots on the surface of drops</font><font color="#000000">
     </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">black</font><font color="#000000">] [
       </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">abs</font><font color="#000000"> (</font><font color="#660096">distancexy</font><font color="#000000"> ([</font><font color="#660096">xcor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">) ([</font><font color="#660096">ycor</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000">)) </font><font color="#660096">-</font><font color="#000000"> [</font><font color="#660096">size</font><font color="#000000">] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">.5</font><font color="#000000"> [  </font><font color="#5a5a5a">; here 'myself' is the drop]</font><font color="#000000">
         </font><font color="#0000aa">face</font><font color="#000000"> </font><font color="#660096">myself</font><font color="#000000"> 
         </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;soap2&quot;</font><font color="#000000">
         ]  
    ]]
    </font><font color="#5a5a5a">; fianlly, convert any remaining black dots.</font><font color="#000000">
    </font><font color="#0000aa">ask</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">black</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">&quot;circle&quot;</font><font color="#000000"> ] [
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;soap2&quot;</font><font color="#000000">
      
      ]       
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> remove-molecules </font><font color="#5a5a5a">; get rid of 10% of the molecules of the color selected in the mystery-molecule pull down</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> cnum </font><font color="#660096">read-from-string</font><font color="#000000"> mystery-molecule 
  </font><font color="#0000aa">let</font><font color="#000000"> n </font><font color="#660096">round</font><font color="#000000"> (</font><font color="#660096">count</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> cnum ]) </font><font color="#660096">*</font><font color="#000000"> </font><font color="#963700">.1</font><font color="#000000">
    </font><font color="#0000aa">repeat</font><font color="#000000"> n [
      </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">one-of</font><font color="#000000"> dots </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">=</font><font color="#000000"> cnum ] [</font><font color="#0000aa">die</font><font color="#000000">]
    ]
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> hide-molecules
  </font><font color="#0000aa">ask</font><font color="#000000"> dots [ </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000"> </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;circle&quot;</font><font color="#000000">]
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#5a5a5a">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</font><font color="#000000">
</font><font color="#5a5a5a">;;;;;; tape recorder proceedures ;;;;;;;</font><font color="#000000">
</font><font color="#5a5a5a">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> save-state  
    </font><font color="#5a5a5a">; this will be all the information needed to re-draw a frame using 'history'</font><font color="#000000">
    </font><font color="#5a5a5a">; and all the information needed to restart the model using 'current-state'</font><font color="#000000">
    </font><font color="#5a5a5a">; a frame will store a list consisting of information on the drops, dots, and surface level</font><font color="#000000">
    </font><font color="#5a5a5a">; frame is added to the end of history, the global that records all the history of a run</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> drop-info []
  </font><font color="#0000aa">let</font><font color="#000000"> full-drop-info []
  </font><font color="#0000aa">ask</font><font color="#000000"> drops [
    </font><font color="#0000aa">set</font><font color="#000000"> drop-info </font><font color="#660096">lput</font><font color="#000000"> (</font><font color="#660096">list</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000">) drop-info  </font><font color="#5a5a5a">; save just the location and size into history</font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> full-drop-info </font><font color="#660096">lput</font><font color="#000000"> (</font><font color="#660096">list</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> vx vy) full-drop-info
    ]   
  </font><font color="#0000aa">let</font><font color="#000000"> dot-info []
  </font><font color="#0000aa">let</font><font color="#000000"> full-dot-info []
  </font><font color="#0000aa">ask</font><font color="#000000"> dots [
    </font><font color="#0000aa">set</font><font color="#000000"> dot-info </font><font color="#660096">lput</font><font color="#000000"> (</font><font color="#660096">list</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000">) dot-info    </font><font color="#5a5a5a">; save just the location and color</font><font color="#000000">
    </font><font color="#0000aa">set</font><font color="#000000"> full-dot-info </font><font color="#660096">lput</font><font color="#000000"> (</font><font color="#660096">list</font><font color="#000000"> </font><font color="#660096">xcor</font><font color="#000000"> </font><font color="#660096">ycor</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> vx vy fx fy owner) full-dot-info
    ]
  </font><font color="#0000aa">let</font><font color="#000000"> logicals </font><font color="#660096">list</font><font color="#000000"> combine-event? merge-event?    
  </font><font color="#0000aa">let</font><font color="#000000"> frame (</font><font color="#660096">list</font><font color="#000000"> surface drop-info dot-info logicals)    </font><font color="#5a5a5a">; create a list of all the information on a frame. </font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> history </font><font color="#660096">lput</font><font color="#000000"> frame history                 </font><font color="#5a5a5a">; frame becomes the last item in the history</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> current-state (</font><font color="#660096">list</font><font color="#000000"> surface full-drop-info full-dot-info)  </font><font color="#5a5a5a">; used to restart the model</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> merge-event? </font><font color="#963700">false</font><font color="#000000">       </font><font color="#5a5a5a">; reset these two flags</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> combine-event? </font><font color="#963700">false</font><font color="#000000"> 
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> restore-state [i]    </font><font color="#5a5a5a">; looks into history and re-draws frame i</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> frame </font><font color="#660096">item</font><font color="#000000"> i history   </font><font color="#5a5a5a">; get the right frame, which has all the information needed to re-draw a frame. </font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> surface-level </font><font color="#660096">first</font><font color="#000000"> frame    </font><font color="#5a5a5a">; first, redraw the patches </font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">patches</font><font color="#000000"> [
    </font><font color="#0000aa">ifelse</font><font color="#000000"> </font><font color="#660096">pycor</font><font color="#000000"> </font><font color="#660096">&gt;=</font><font color="#000000"> oil-top [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">white</font><font color="#000000"> ]
     [</font><font color="#0000aa">ifelse</font><font color="#000000"> </font><font color="#660096">pycor</font><font color="#000000"> </font><font color="#660096">&gt;=</font><font color="#000000"> surface-level 
        [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">48</font><font color="#000000">]           </font><font color="#5a5a5a">; light yellow</font><font color="#000000">
        [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">blue</font><font color="#000000">]]]
  
  </font><font color="#0000aa">let</font><font color="#000000"> drop-info </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> frame     </font><font color="#5a5a5a">; recreate the drops</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> ndrops </font><font color="#660096">length</font><font color="#000000"> drop-info 
  </font><font color="#0000aa">ask</font><font color="#000000"> drops [</font><font color="#0000aa">die</font><font color="#000000">]
  </font><font color="#0000aa">let</font><font color="#000000"> j </font><font color="#963700">0</font><font color="#000000">
  </font><font color="#0000aa">while</font><font color="#000000"> [j </font><font color="#660096">&lt;</font><font color="#000000"> ndrops] [
    create-drops </font><font color="#963700">1</font><font color="#000000"> [
      </font><font color="#0000aa">let</font><font color="#000000"> data </font><font color="#660096">item</font><font color="#000000"> j drop-info
      </font><font color="#0000aa">setxy</font><font color="#000000"> (</font><font color="#660096">first</font><font color="#000000"> data) (</font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> data)
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">48</font><font color="#000000"> 
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;circle&quot;</font><font color="#000000"> ]
    </font><font color="#0000aa">set</font><font color="#000000"> j j </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> ]
  
  </font><font color="#0000aa">let</font><font color="#000000"> dot-info </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> frame      </font><font color="#5a5a5a">; recreate the dots</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> ndots </font><font color="#660096">length</font><font color="#000000"> dot-info 
  </font><font color="#0000aa">ask</font><font color="#000000"> dots [</font><font color="#0000aa">die</font><font color="#000000">]
  </font><font color="#0000aa">set</font><font color="#000000"> j </font><font color="#963700">0</font><font color="#000000">
  </font><font color="#0000aa">while</font><font color="#000000"> [j </font><font color="#660096">&lt;</font><font color="#000000"> ndots] [
    create-dots </font><font color="#963700">1</font><font color="#000000"> [
      </font><font color="#0000aa">let</font><font color="#000000"> data </font><font color="#660096">item</font><font color="#000000"> j dot-info
      </font><font color="#0000aa">setxy</font><font color="#000000"> (</font><font color="#660096">first</font><font color="#000000"> data) (</font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> data)
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;circle&quot;</font><font color="#000000"> ]
    </font><font color="#0000aa">set</font><font color="#000000"> j j </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> ]
  
  </font><font color="#0000aa">set</font><font color="#000000"> tape-position location-of i
  </font><font color="#0000aa">set</font><font color="#000000"> rerun-index i
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> process-rerun              </font><font color="#5a5a5a">; the re-run button goes here</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> mode </font><font color="#963700">2</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> rerun-index current-index </font><font color="#5a5a5a">; start the rerun at the current tape-position</font><font color="#000000">
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> re-run                              </font><font color="#5a5a5a">; in mode 2 this is called from the main loop</font><font color="#000000">
  </font><font color="#0000aa">every</font><font color="#000000"> </font><font color="#963700">.02</font><font color="#000000"> [                          </font><font color="#5a5a5a">; every .02 sec </font><font color="#000000">
    restore-state rerun-index          </font><font color="#5a5a5a">; restore the state for rerun-index</font><font color="#000000">
    </font><font color="#0000aa">ifelse</font><font color="#000000"> (rerun-index </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> </font><font color="#660096">&gt;=</font><font color="#000000"> (</font><font color="#660096">length</font><font color="#000000"> history)) 
      [ restart-model </font><font color="#0000aa">set</font><font color="#000000"> mode </font><font color="#963700">0</font><font color="#000000"> ]     </font><font color="#5a5a5a">; switch to compute if the last state in history has been restored</font><font color="#000000">
      [ </font><font color="#0000aa">set</font><font color="#000000"> rerun-index rerun-index </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">  </font><font color="#5a5a5a">; otherwise advance the rerun index</font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> tape-position location-of rerun-index </font><font color="#5a5a5a">; </font><font color="#000000">
        </font><font color="#0000aa">set</font><font color="#000000"> old-slider tape-position  </font><font color="#5a5a5a">; needed to avoid switching to mode 5</font><font color="#000000">
        ]  
    ]
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> use-slider                     </font><font color="#5a5a5a">;  reads the tape slider and restores the right frame</font><font color="#000000">
  </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">length</font><font color="#000000"> history </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [
    restore-state current-index
    </font><font color="#0000aa">set</font><font color="#000000"> old-slider tape-position
    </font><font color="#0000aa">wait</font><font color="#000000"> </font><font color="#963700">.01</font><font color="#000000"> ]
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to</font><font color="#000000"> restart-model  
  </font><font color="#0000aa">set</font><font color="#000000"> mode </font><font color="#963700">0</font><font color="#000000">  </font><font color="#5a5a5a">; </font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> surface-level </font><font color="#660096">first</font><font color="#000000"> current-state    </font><font color="#5a5a5a">; first, redraw the patches </font><font color="#000000">
  </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">patches</font><font color="#000000"> [
    </font><font color="#0000aa">ifelse</font><font color="#000000"> </font><font color="#660096">pycor</font><font color="#000000"> </font><font color="#660096">&gt;=</font><font color="#000000"> oil-top [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">white</font><font color="#000000"> ]
     [</font><font color="#0000aa">ifelse</font><font color="#000000"> </font><font color="#660096">pycor</font><font color="#000000"> </font><font color="#660096">&gt;=</font><font color="#000000"> surface-level 
        [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">48</font><font color="#000000">]           </font><font color="#5a5a5a">; light yellow</font><font color="#000000">
        [</font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> </font><font color="#963700">blue</font><font color="#000000">]]]
  
  </font><font color="#0000aa">let</font><font color="#000000"> drop-info </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> current-state     </font><font color="#5a5a5a">; recreate the drops</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> ndrops </font><font color="#660096">length</font><font color="#000000"> drop-info 
  </font><font color="#0000aa">ask</font><font color="#000000"> drops [</font><font color="#0000aa">die</font><font color="#000000">]
  </font><font color="#0000aa">let</font><font color="#000000"> j </font><font color="#963700">0</font><font color="#000000">
  </font><font color="#0000aa">while</font><font color="#000000"> [j </font><font color="#660096">&lt;</font><font color="#000000"> ndrops] [
    create-drops </font><font color="#963700">1</font><font color="#000000"> [
      </font><font color="#0000aa">let</font><font color="#000000"> data </font><font color="#660096">item</font><font color="#000000"> j drop-info
      </font><font color="#0000aa">setxy</font><font color="#000000"> (</font><font color="#660096">first</font><font color="#000000"> data) (</font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> data)
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> vx </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">3</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">48</font><font color="#000000"> 
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;circle&quot;</font><font color="#000000"> ]
    </font><font color="#0000aa">set</font><font color="#000000"> j j </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> ]
  
  </font><font color="#0000aa">let</font><font color="#000000"> dot-info </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> current-state      </font><font color="#5a5a5a">; recreate the dots</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> ndots </font><font color="#660096">length</font><font color="#000000"> dot-info 
  </font><font color="#0000aa">ask</font><font color="#000000"> dots [</font><font color="#0000aa">die</font><font color="#000000">]
  </font><font color="#0000aa">set</font><font color="#000000"> j </font><font color="#963700">0</font><font color="#000000">
  </font><font color="#0000aa">while</font><font color="#000000"> [j </font><font color="#660096">&lt;</font><font color="#000000"> ndots] [
    create-dots </font><font color="#963700">1</font><font color="#000000"> [
      </font><font color="#0000aa">let</font><font color="#000000"> data </font><font color="#660096">item</font><font color="#000000"> j dot-info
      </font><font color="#0000aa">setxy</font><font color="#000000"> (</font><font color="#660096">first</font><font color="#000000"> data) (</font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> data)
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> vx </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">3</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> vy </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> fx </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">5</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> fy </font><font color="#660096">item</font><font color="#000000"> </font><font color="#963700">6</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> owner </font><font color="#660096">last</font><font color="#000000"> data
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">size</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000">
      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;circle&quot;</font><font color="#000000"> ]
    </font><font color="#0000aa">set</font><font color="#000000"> j j </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> ]
  </font><font color="#0000aa">set</font><font color="#000000"> tape-position </font><font color="#963700">100</font><font color="#000000">
  </font><font color="#0000aa">set</font><font color="#000000"> old-slider </font><font color="#963700">100</font><font color="#000000">
</font><font color="#007f69">end</font><font color="#000000">


</font><font color="#5a5a5a">;;;;;;;;;;;;;;;;;;;;;;;;;;;;</font><font color="#000000">
</font><font color="#5a5a5a">;;;;; support functions ;;;;</font><font color="#000000">
</font><font color="#5a5a5a">;;;;;;;;;;;;;;;;;;;;;;;;;;;;</font><font color="#000000">


</font><font color="#007f69">to-report</font><font color="#000000"> current-index     </font><font color="#5a5a5a">; reads the tape position and returns an index that varies from 0 to 100 in steps of .1</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> len </font><font color="#660096">length</font><font color="#000000"> history    </font><font color="#5a5a5a">; the length of history runs from </font><font color="#000000">
  </font><font color="#0000aa">report</font><font color="#000000"> </font><font color="#660096">floor</font><font color="#000000"> ((len </font><font color="#660096">-</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> ) </font><font color="#660096">*</font><font color="#000000"> tape-position </font><font color="#660096">*</font><font color="#000000"> </font><font color="#963700">.01</font><font color="#000000">)
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to-report</font><font color="#000000"> location-of [i]     </font><font color="#5a5a5a">; returns the location of the Tape-position slider (0-100) given i, the current index into history</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> len </font><font color="#660096">length</font><font color="#000000"> history
  </font><font color="#0000aa">ifelse</font><font color="#000000"> len </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> i </font><font color="#660096">&lt;</font><font color="#000000"> len
   [</font><font color="#0000aa">report</font><font color="#000000"> </font><font color="#660096">precision</font><font color="#000000"> (</font><font color="#963700">100</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> i </font><font color="#660096">/</font><font color="#000000"> (len </font><font color="#660096">-</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> ) ) </font><font color="#963700">1</font><font color="#000000"> ]
   [</font><font color="#0000aa">report</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">]
</font><font color="#007f69">end</font><font color="#000000">

</font><font color="#007f69">to-report</font><font color="#000000"> random-between [a b] </font><font color="#5a5a5a">; returns a number in the range [a, b] inclusive in steps of .01</font><font color="#000000">
  </font><font color="#0000aa">let</font><font color="#000000"> range (</font><font color="#963700">100</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> ( b </font><font color="#660096">-</font><font color="#000000"> a ) </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">)
  </font><font color="#0000aa">report</font><font color="#000000"> a </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">.01</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> </font><font color="#660096">random</font><font color="#000000"> range
</font><font color="#007f69">end</font><font color="#000000">
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
</font>
</pre>

</body>
</html>
